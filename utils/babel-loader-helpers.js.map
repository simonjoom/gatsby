{"version":3,"sources":["../../src/utils/babel-loader-helpers.js"],"names":["path","require","_","prepareOptions","babel","resolve","pluginBabelConfig","test","plugins","presets","process","env","NODE_ENV","join","cwd","stage","GATSBY_BUILD_STAGE","requiredPlugins","createConfigItem","type","requiredPresets","push","fallbackPresets","fallbackPlugins","targets","node","browsers","browserslist","loose","modules","useBuiltIns","pragma","development","helpers","regenerator","reduxPlugins","reduxPresets","forEach","plugin","name","options","preset","mergeConfigItemOptions","items","itemToMerge","index","findIndex","i","file","resolved","merge","exports"],"mappings":"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","sourcesContent":["const path = require(`path`)\nconst _ = require(`lodash`)\n\nconst prepareOptions = (babel, resolve = require.resolve) => {\n  let pluginBabelConfig = { test: { plugins: [], presets: [] } }\n  if (process.env.NODE_ENV !== `test`) {\n    pluginBabelConfig = require(path.join(\n      process.cwd(),\n      `./.cache/babelState.json`\n    ))\n  }\n\n  const stage = process.env.GATSBY_BUILD_STAGE || `test`\n\n  // Required plugins/presets\n  const requiredPlugins = [\n    babel.createConfigItem([resolve(`babel-plugin-remove-graphql-queries`)], {\n      type: `plugin`,\n    }),\n  ]\n  const requiredPresets = []\n\n  // Stage specific plugins to add\n  if (stage === `build-html` || stage === `develop-html`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`babel-plugin-dynamic-import-node`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  if (stage === `develop`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`react-hot-loader/babel`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  // Fallback presets/plugins\n  const fallbackPresets = []\n  const fallbackPlugins = []\n\n  let targets\n  if (stage === `build-html`) {\n    targets = {\n      node: `current`,\n    }\n  } else {\n    targets = {\n      browsers: pluginBabelConfig.browserslist,\n    }\n  }\n\n  fallbackPresets.push(\n    babel.createConfigItem(\n      [\n        resolve(`@babel/preset-env`),\n        {\n          loose: true,\n          modules: false,\n          useBuiltIns: `usage`,\n          targets,\n        },\n      ],\n      {\n        type: `preset`,\n      }\n    )\n  )\n\n  fallbackPresets.push(\n    babel.createConfigItem(\n      [\n        resolve(`@babel/preset-react`),\n        {\n          useBuiltIns: true,\n          pragma: `React.createElement`,\n          development: stage === `develop`,\n        },\n      ],\n      {\n        type: `preset`,\n      }\n    )\n  )\n\n  fallbackPlugins.push(\n    babel.createConfigItem(\n      [\n        resolve(`@babel/plugin-proposal-class-properties`),\n        {\n          loose: true,\n        },\n      ],\n      {\n        type: `plugin`,\n      }\n    )\n  )\n\n  fallbackPlugins.push(\n    babel.createConfigItem([resolve(`babel-plugin-macros`)], {\n      type: `plugin`,\n    })\n  )\n\n  fallbackPlugins.push(\n    babel.createConfigItem([resolve(`@babel/plugin-syntax-dynamic-import`)], {\n      type: `plugin`,\n    })\n  )\n\n  fallbackPlugins.push(\n    babel.createConfigItem(\n      [\n        resolve(`@babel/plugin-transform-runtime`),\n        {\n          helpers: true,\n          regenerator: true,\n        },\n      ],\n      {\n        type: `plugin`,\n      }\n    )\n  )\n\n  // Go through babel state and create config items for presets/plugins from.\n  const reduxPlugins = []\n  const reduxPresets = []\n  pluginBabelConfig[stage].plugins.forEach(plugin => {\n    reduxPlugins.push(\n      babel.createConfigItem([resolve(plugin.name), plugin.options], {\n        type: `plugin`,\n      })\n    )\n  })\n  pluginBabelConfig[stage].presets.forEach(preset => {\n    reduxPresets.push(\n      babel.createConfigItem([resolve(preset.name), preset.options], {\n        type: `preset`,\n      })\n    )\n  })\n\n  return [\n    reduxPresets,\n    reduxPlugins,\n    requiredPresets,\n    requiredPlugins,\n    fallbackPlugins,\n    fallbackPresets,\n  ]\n}\n\nconst mergeConfigItemOptions = ({ items, itemToMerge, type, babel }) => {\n  const index = _.findIndex(\n    items,\n    i => i.file.resolved === itemToMerge.file.resolved\n  )\n\n  // If this exist, merge the options, otherwise, add it to the array\n  if (index !== -1) {\n    items[index] = babel.createConfigItem(\n      [\n        itemToMerge.file.resolved,\n        _.merge({}, items[index].options, itemToMerge.options),\n      ],\n      {\n        type,\n      }\n    )\n  } else {\n    items.push(itemToMerge)\n  }\n\n  return items\n}\n\n// Export helper functions for testing\nexports.prepareOptions = prepareOptions\nexports.mergeConfigItemOptions = mergeConfigItemOptions\n"],"file":"babel-loader-helpers.js"}