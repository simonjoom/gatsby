{"version":3,"sources":["../../../src/internal-plugins/query-runner/pages-writer.js"],"names":["_","require","fs","crypto","store","emitter","lastHash","writePages","bootstrapFinished","getState","program","jsonDataPaths","pages","values","pagesComponentDependencies","pagesData","forEach","path","matchPath","componentChunkName","jsonName","pageComponentsChunkNames","push","sortBy","p","newHash","createHash","update","JSON","stringify","digest","Promise","resolve","components","json","component","dataPath","uniqBy","c","syncRequires","map","join","asyncRequires","directory","writeAndMove","file","data","destination","tmp","Date","now","writeFile","then","move","overwrite","result","all","dataPaths","exports","oldPages","debouncedWritePages","debounce","isEqual","leading","on"],"mappings":";;;;;;AAMA;;AANA,MAAMA,CAAC,GAAGC,OAAO,CAAE,QAAF,CAAjB;;AACA,MAAMC,EAAE,GAAGD,OAAO,CAAE,UAAF,CAAlB;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAE,QAAF,CAAtB;;iBAE2BA,OAAO,CAAE,cAAF,C;MAA1BG,K,YAAAA,K;MAAOC,O,YAAAA,O;;AAIf,IAAIC,QAAQ,GAAG,IAAf,C,CAEA;;AACA,MAAMC,UAAU;AAAA;AAAA;AAAA,6CAAG,aAAY;AAC7BC,IAAAA,iBAAiB,GAAG,IAApB;;AAD6B,0BAEWJ,KAAK,CAACK,QAAN,EAFX;AAAA,QAEvBC,OAFuB,mBAEvBA,OAFuB;AAAA,QAEdC,aAFc,mBAEdA,aAFc;AAAA,QAECC,KAFD,mBAECA,KAFD;;AAG7BA,IAAAA,KAAK,GAAG,CAAC,GAAGA,KAAK,CAACC,MAAN,EAAJ,CAAR;AAEA,UAAMC,0BAA0B,GAAG,EAAnC,CAL6B,CAO7B;;AACA,QAAIC,SAAS,GAAG,EAAhB;AACAH,IAAAA,KAAK,CAACI,OAAN,CAAc,CAAC;AAAEC,MAAAA,IAAF;AAAQC,MAAAA,SAAR;AAAmBC,MAAAA,kBAAnB;AAAuCC,MAAAA;AAAvC,KAAD,KAAuD;AACnE,YAAMC,wBAAwB,GAAG;AAC/BF,QAAAA;AAD+B,OAAjC;;AAIA,UAAIT,OAAO,CAACV,CAAR,CAAU,CAAV,MAAkB,SAAtB,EAAgC;AAC9Bc,QAAAA,0BAA0B,CAACG,IAAD,CAA1B,GAAmCI,wBAAnC;AACD;;AAEDN,MAAAA,SAAS,CAACO,IAAV,mBACKD,wBADL;AAEED,QAAAA,QAFF;AAGEH,QAAAA,IAHF;AAIEC,QAAAA;AAJF;AAMD,KAfD;AAiBAH,IAAAA,SAAS,GAAGf,CAAC,CAACuB,MAAF,CACVR,SADU,EAEV;AACA;AACAS,IAAAA,CAAC,IAAKA,CAAC,CAACN,SAAF,GAAc,CAAd,GAAkB,CAJd,CAAZ;AAOA,UAAMO,OAAO,GAAGtB,MAAM,CACnBuB,UADa,CACD,KADC,EAEbC,MAFa,CAENC,IAAI,CAACC,SAAL,CAAef,0BAAf,CAFM,EAGbgB,MAHa,CAGL,KAHK,CAAhB;;AAKA,QAAIL,OAAO,KAAKnB,QAAhB,EAA0B;AACxB;AACA,aAAOyB,OAAO,CAACC,OAAR,EAAP;AACD;;AAED1B,IAAAA,QAAQ,GAAGmB,OAAX,CA3C6B,CA6C7B;;AACA,QAAIQ,UAAU,GAAG,EAAjB;AACA,QAAIC,IAAI,GAAG,EAAX;AAEAtB,IAAAA,KAAK,CAACI,OAAN,CAAcQ,CAAC,IAAI;AACjBS,MAAAA,UAAU,CAACX,IAAX,CAAgB;AACdH,QAAAA,kBAAkB,EAAEK,CAAC,CAACL,kBADR;AAEdgB,QAAAA,SAAS,EAAEX,CAAC,CAACW;AAFC,OAAhB;;AAKA,UAAIX,CAAC,CAACJ,QAAF,IAAcT,aAAa,CAACa,CAAC,CAACJ,QAAH,CAA/B,EAA6C;AAC3Cc,QAAAA,IAAI,CAACZ,IAAL,CAAU;AAAEF,UAAAA,QAAQ,EAAEI,CAAC,CAACJ,QAAd;AAAwBgB,UAAAA,QAAQ,EAAEzB,aAAa,CAACa,CAAC,CAACJ,QAAH;AAA/C,SAAV;AACD;AACF,KATD;AAWAa,IAAAA,UAAU,GAAGjC,CAAC,CAACqC,MAAF,CAASJ,UAAT,EAAqBK,CAAC,IAAIA,CAAC,CAACnB,kBAA5B,CAAb,CA5D6B,CA8D7B;;AACA,QAAIoB,YAAY,GAAI;;KAApB;AAGAA,IAAAA,YAAY,IAAK,2BAA0BN,UAAU,CAClDO,GADwC,CAEvCF,CAAC,IACE,MAAKA,CAAC,CAACnB,kBAAmB,6BAA4B,oBACrDmB,CAAC,CAACH,SADmD,CAErD,KALmC,EAOxCM,IAPwC,CAOlC,KAPkC,CAO5B;MAPf,CAlE6B,CA4E7B;;AACA,QAAIC,aAAa,GAAI;;GAArB;AAGAA,IAAAA,aAAa,IAAK,2BAA0BT,UAAU,CACnDO,GADyC,CAExCF,CAAC,IACE,MAAKA,CAAC,CAACnB,kBAAmB,oBAAmB,oBAC5CmB,CAAC,CAACH,SAD0C,CAE5C,2BAA0BG,CAAC,CAACnB,kBAAmB,OALX,EAOzCsB,IAPyC,CAOnC,KAPmC,CAO7B;MAPf;AAUAC,IAAAA,aAAa,IAAK,gCAA+B,oBAC/ChC,OAAO,CAACiC,SADuC,EAE9C,QAF8C,EAG9C,WAH8C,CAI/C,QAJF;;AAMA,UAAMC,YAAY,GAAG,CAACC,IAAD,EAAOC,IAAP,KAAgB;AACnC,YAAMC,WAAW,GAAG,oBAASrC,OAAO,CAACiC,SAAjB,EAA6B,QAA7B,EAAsCE,IAAtC,CAApB;AACA,YAAMG,GAAG,GAAI,GAAED,WAAY,IAAGE,IAAI,CAACC,GAAL,EAAW,EAAzC;AACA,aAAOhD,EAAE,CACNiD,SADI,CACMH,GADN,EACWF,IADX,EAEJM,IAFI,CAEC,MAAMlD,EAAE,CAACmD,IAAH,CAAQL,GAAR,EAAaD,WAAb,EAA0B;AAAEO,QAAAA,SAAS,EAAE;AAAb,OAA1B,CAFP,CAAP;AAGD,KAND;;AAQA,UAAMC,MAAM,SAASxB,OAAO,CAACyB,GAAR,CAAY,CAC/BZ,YAAY,CAAE,YAAF,EAAehB,IAAI,CAACC,SAAL,CAAed,SAAf,EAA0B,IAA1B,EAAgC,CAAhC,CAAf,CADmB,EAE/B6B,YAAY,CAAE,kBAAF,EAAqBL,YAArB,CAFmB,EAG/BK,YAAY,CAAE,mBAAF,EAAsBF,aAAtB,CAHmB,EAI/BE,YAAY,CACT,WADS,EAEVhB,IAAI,CAACC,SAAL,CAAe;AACbjB,MAAAA,KAAK,EAAEG,SADM;AAEb0C,MAAAA,SAAS,EAAE9C;AAFE,KAAf,CAFU,CAJmB,CAAZ,CAArB;AAaA,WAAO4C,MAAP;AACD,GAtHe;;AAAA,kBAAVhD,UAAU;AAAA;AAAA;AAAA,GAAhB;;AAwHAmD,OAAO,CAACnD,UAAR,GAAqBA,UAArB;AAEA,IAAIC,iBAAiB,GAAG,KAAxB;AACA,IAAImD,QAAJ;;AACA,MAAMC,mBAAmB,GAAG5D,CAAC,CAAC6D,QAAF,CAC1B,MAAM;AACJ;AACA,MAAIrD,iBAAiB,IAAI,CAACR,CAAC,CAAC8D,OAAF,CAAUH,QAAV,EAAoBvD,KAAK,CAACK,QAAN,GAAiBG,KAArC,CAA1B,EAAuE;AACrEL,IAAAA,UAAU;AACVoD,IAAAA,QAAQ,GAAGvD,KAAK,CAACK,QAAN,GAAiBG,KAA5B;AACD;AACF,CAPyB,EAQ1B,GAR0B,EAS1B;AAAEmD,EAAAA,OAAO,EAAE;AAAX,CAT0B,CAA5B;;AAWA1D,OAAO,CAAC2D,EAAR,CAAY,aAAZ,EAA0B,MAAM;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAIxD,iBAAJ,EAAuB;AACrBoD,IAAAA,mBAAmB;AACpB;AACF,CAXD;AAaAvD,OAAO,CAAC2D,EAAR,CAAY,iBAAZ,EAA8B,MAAM;AAClCJ,EAAAA,mBAAmB;AACpB,CAFD;AAGAvD,OAAO,CAAC2D,EAAR,CAAY,aAAZ,EAA0B,MAAM;AAC9BJ,EAAAA,mBAAmB;AACpB,CAFD;AAGAvD,OAAO,CAAC2D,EAAR,CAAY,qBAAZ,EAAkC,MAAM;AACtCJ,EAAAA,mBAAmB;AACpB,CAFD","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\n\nconst { store, emitter } = require(`../../redux/`)\n\nimport { joinPath } from \"../../utils/path\"\n\nlet lastHash = null\n\n// Write out pages information.\nconst writePages = async () => {\n  bootstrapFinished = true\n  let { program, jsonDataPaths, pages } = store.getState()\n  pages = [...pages.values()]\n\n  const pagesComponentDependencies = {}\n\n  // Write out pages.json\n  let pagesData = []\n  pages.forEach(({ path, matchPath, componentChunkName, jsonName }) => {\n    const pageComponentsChunkNames = {\n      componentChunkName,\n    }\n\n    if (program._[0] === `develop`) {\n      pagesComponentDependencies[path] = pageComponentsChunkNames\n    }\n\n    pagesData.push({\n      ...pageComponentsChunkNames,\n      jsonName,\n      path,\n      matchPath,\n    })\n  })\n\n  pagesData = _.sortBy(\n    pagesData,\n    // Sort pages with matchPath to end so explicit routes\n    // will match before general.\n    p => (p.matchPath ? 1 : 0)\n  )\n\n  const newHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pagesComponentDependencies))\n    .digest(`hex`)\n\n  if (newHash === lastHash) {\n    // components didn't change - no need to rewrite pages.json\n    return Promise.resolve()\n  }\n\n  lastHash = newHash\n\n  // Get list of components, and json files.\n  let components = []\n  let json = []\n\n  pages.forEach(p => {\n    components.push({\n      componentChunkName: p.componentChunkName,\n      component: p.component,\n    })\n\n    if (p.jsonName && jsonDataPaths[p.jsonName]) {\n      json.push({ jsonName: p.jsonName, dataPath: jsonDataPaths[p.jsonName] })\n    }\n  })\n\n  components = _.uniqBy(components, c => c.componentChunkName)\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.component\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": () => import(\"${joinPath(\n          c.component\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  asyncRequires += `exports.data = () => import(\"${joinPath(\n    program.directory,\n    `.cache`,\n    `data.json`\n  )}\")\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  const result = await Promise.all([\n    writeAndMove(`pages.json`, JSON.stringify(pagesData, null, 4)),\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(\n      `data.json`,\n      JSON.stringify({\n        pages: pagesData,\n        dataPaths: jsonDataPaths,\n      })\n    ),\n  ])\n\n  return result\n}\n\nexports.writePages = writePages\n\nlet bootstrapFinished = false\nlet oldPages\nconst debouncedWritePages = _.debounce(\n  () => {\n    // Don't write pages again until bootstrap has finished.\n    if (bootstrapFinished && !_.isEqual(oldPages, store.getState().pages)) {\n      writePages()\n      oldPages = store.getState().pages\n    }\n  },\n  500,\n  { leading: true }\n)\nemitter.on(`CREATE_PAGE`, () => {\n  // Ignore CREATE_PAGE until bootstrap is finished\n  // as this is called many many times during bootstrap and\n  // we can ignore them until CREATE_PAGE_END is called.\n  //\n  // After bootstrap, we need to listen for this as stateful page\n  // creators e.g. the plugin \"gatsby-plugin-page-creator\"\n  // calls createPage directly so CREATE_PAGE_END won't get fired.\n  if (bootstrapFinished) {\n    debouncedWritePages()\n  }\n})\n\nemitter.on(`CREATE_PAGE_END`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE_BY_PATH`, () => {\n  debouncedWritePages()\n})\n"],"file":"pages-writer.js"}